# Webアプリケーション概要

## Webアプリケーションとは

- Webブラウザをインターフェースとして入出力するアプリケーション
  - 通信はHTTP、表示はHTML、CSS
- 実際のアプリはサーバーにある
- ≠ネイティブアプリ、デスクトップアプリ
  - 内部的にはWebアプリが提供するAPIを叩いている場合も



## Webサーバーの役割

- HTTPを処理するサーバー
  - クライアントからリクエストを受け付けて
  - 所望の結果を返す
- Apache,IIS,nginx...

### Webサーバーがやること

- リクエストを受け付ける
- 結果を(読み込む｜計算する)
- 結果を送り返す



- 通信と結果のセット
  - 入力＋計算＋出力=プログラムの本質
  - 通信をプログラムでどう行うか→Socket

### Socket

- サーバーとクライアントで通信するためのAPI
  - 主にTCP、UDPを使う
  - 同じマシン同士で通信しても、別のマシンと通信してもよい

### Socket: クライアント側

- やること
  - 初期化 socket()
  - サーバーと接続 connect()
  - 送信 write() / 受信 read()
  - 終了 close()

### Socket: サーバー側

- やること
  - socket()
  - アドレスを設定 bind()
  - リクエスト受付 listen()
  - リクエストを確立 accept()
  - read() / write()
  - close()

### 複数のリクエストが来たら

- サーバーが１つのリクエストを処理している時に別のリクエストがくる

### 同時に複数のリクエストを捌く

- リクエストの待受とリクエストの処理を同時に行えると良い
  - acceptが返ったら処理を開始
  - 処理の結果を待たずに、すぐにacceptに戻る
- プロセスやスレッドを使う

### プロセス

- プログラムの実行の単位
  - コマンドやアプリを起動するとプロセスが立ち上がる
  - 別のプロセスのメモリにはアクセスできない
  - 異なるプロセスは並列に動くことができる
- Webサーバーでは
  - リクエストを受付
  - 処理プロセスを起動してソケットを引き継ぐ

### スレッド

- 1つのプロセスの中の処理の単位
  - プロセスより軽い
  - 並列に実行可能
  - 同じプロセスの別のスレッドのメモリにアクセスできる
- Webサーバーでは
  - リクエストを受付
  - 処理スレッドを起動して処理をする



- Socketとプロセス/スレッドを使えば、webサーバーのようなものを作れる
  - 接続数が非常に多くなると？(C10K問題)→非同期I/Oなど



## Webアプリケーション

- Webは静的なページを返すだけじゃない
  - Input-Process-Output(=プログラム)
  - Processで任意のプログラムを実行して結果を返す

### CGI: Common Gateway Interface

- Webサーバーとプログラムがやりとりするためのインターフェース
  - リクエストが来るたびにアプリのプロセスを起動する
  - リクエストの内容は、環境変数や標準入力で渡される
  - 結果は標準出力で返す

### Webアプリケーションサーバー

- Webアプリケーションを実行するサーバー
  - CGIと異なり、通常起動しっぱなし
  - Webサーバーがアプリケーションサーバーにリクエストを中継する
    - 主にHTTPでやりとり
  - アプリケーションサーバーとアプリの間
    - 特定のメソッドを呼んだりしてやりとり

### 永続化/データベース

- Webアプリを作るとデータを保存したくなる
  - プログラムやマシンが終了してもデータが残る
  - cf. memcached
- 色々なやり方
  - 素朴にファイルに保存
    - 自分で競合・不整合などを回避するのは大変
    - 大規模だと大変になる
  - データベース管理システム(DBMS)

### データベース管理システム(DBMS)

- RDBMS/SQL
  - 「関係モデル」というものを扱うデータベース
  - SQLという言語で操作する
- NoSQL
  - SQLへ対抗して出てきたデータベース(大抵速いがトレードオフ有り)
    - キーバリューストア(KVS)
      - キーとバリューのペアの形式だけ保存
    - ドキュメント志向データベース
      - 柔軟な構造のデータを保存



### ログイン

- Webアプリにはほぼ必須な機能
  - ユーザー毎にデータを保存/ユーザーを特定
  - ログインした後、別のページから戻ってきてもログインされたまま
  - どう実現する？

### Cookie(RFC 6265)

- サーバー側からクライアントにデータを保存される仕組み
  - サーバー：「Set-Cookie: <キー>=<値>」というヘッダーを載せてレスポンスを返す
    - クライアントはそのペアを保存する
  - クライアントはリクエストに「Cookie: <キー>=<値>」を載せる
    - Set-Cookieを返してきたドメインにだけ送る
- HTTPが状態を持つことができる

### セッション

- 一連のアクセスでデータを保存する仕組み
  - Cookieじゃセキュリティ的に。。。
    - パスワードを毎回送る？勝手に書き換えられたら？
  - データ量に限界
- セッション開始時(ログイン時に)ランダムなIDを発行
  - それをCookieに保持する
  - データはIDをキーにサーバー側に保存する

### パスワードの保存

- ログインできるWebアプリを作る場合ユーザー登録が必要
  - 多くの場合、ユーザー名とパスワードを登録させる
  - パスワードをデータベースに保存していい？
  - 情報流出したら？

### パスワードのハッシュ化

- パスワードはハッシュ関数を通したハッシュ値を保存する
  - ログイン時は入力されたパスワードのハッシュ値を取り、保存されているハッシュ値と比較
  - 一致すればOK
- ハッシュ関数
  - 任意の長さのバイト列から固定長のバイト列を出力
  - 出力から入力の値の推測が難しい
  - SHA-2,SHA-1,MD5など
  - より安全に：salt, HMAC...

### HTTPS

- HTTPは通信内容が丸見え
  - パスワードを送ったら？セッションID見られたら？
- HTTPをTLSで暗号化して通信する→HTTPS
  - 内容を見られない。改ざんされない。なりすまされない。



### Webアプリケーションフレームワーク

- Webアプリを作るのに便利な機能が詰まったライブラリ
  - HTTPの処理、Cookie、データベースへのアクセス、テンプレートエンジンなど
  - 現代でWebアプリを新たに作るなら、なんらかのフレームワークを使うことになる



## フロントエンド

### HTML

- 文書に構造や意味を与えるための言語
  - 見出し、段落、他の文書へのリンク、・・・
  - \<h1>\</h1>, \<p>\</p>, \<a href="https://~">\</a>

- それぞれのタグがどういう意味を持つかルールで決まっている
  - 正しい使い方をする→機械が読める→スクリーンリーダが読める→アクセシブル

### テンプレートエンジン

- HTMLの中にデータを埋めたり、プログラム的に表示を変える仕組み
  - JSP, Freemaker, PHP, Smarty, eRuby, ...
- 動的にHTMLを組み立てるためのツール

### CSS

- HTMLの文書の見た目を決めるための仕組み
  - 文字の大きさ、色、背景
- 意味と見た目を分離する
  - HTMLには見た目を書かない

### JavaScript

- 現代のWebアプリはサーバー側だけでは完結しない
  - JavaScriptをブラウザで動かしてダイナミックな動作をする
  - DOM操作
    - JavaScriptを使って、画面を書き換える
  - Ajax/XHR
    - JavaScriptからHTTP通信を行う。画面遷移せずに色々なアクションを行える
  - フレームワーク
    - JavaScriptにもフレームワークがさまざま存在
    - React, Vue, Closure Libarary, etc.

### Web API

- Webアプリケーションの処理をネットワーク越しに呼び出す

  - HTMLではなくデータ(JSON、XML等)を返す
  - サーバー内のデータを更新する
  - JavaScriptから呼ぶ

  